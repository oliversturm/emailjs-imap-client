'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.parseNAMESPACE = parseNAMESPACE;
exports.parseNAMESPACEElement = parseNAMESPACEElement;
exports.parseSELECT = parseSELECT;
exports.parseENVELOPE = parseENVELOPE;
exports.parseBODYSTRUCTURE = parseBODYSTRUCTURE;
exports.parseFETCH = parseFETCH;
exports.parseSEARCH = parseSEARCH;
exports.parseSORT = parseSORT;

var _emailjsAddressparser = require('emailjs-addressparser');

var _emailjsAddressparser2 = _interopRequireDefault(_emailjsAddressparser);

var _emailjsImapHandler = require('emailjs-imap-handler');

var _ramda = require('ramda');

var _emailjsMimeCodec = require('emailjs-mime-codec');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Parses NAMESPACE response
 *
 * @param {Object} response
 * @return {Object} Namespaces object
 */
function parseNAMESPACE(response) {
  if (!response.payload || !response.payload.NAMESPACE || !response.payload.NAMESPACE.length) {
    return false;
  }

  let attributes = [].concat(response.payload.NAMESPACE.pop().attributes || []);
  if (!attributes.length) {
    return false;
  }

  return {
    personal: parseNAMESPACEElement(attributes[0]),
    users: parseNAMESPACEElement(attributes[1]),
    shared: parseNAMESPACEElement(attributes[2])
  };
}

/**
 * Parses a NAMESPACE element
 *
 * @param {Object} element
 * @return {Object} Namespaces element object
 */
function parseNAMESPACEElement(element) {
  if (!element) {
    return false;
  }

  element = [].concat(element || []);
  return element.map(ns => {
    if (!ns || !ns.length) {
      return false;
    }

    return {
      prefix: ns[0].value,
      delimiter: ns[1] && ns[1].value // The delimiter can legally be NIL which maps to null
    };
  });
}

/**
 * Parses SELECT response
 *
 * @param {Object} response
 * @return {Object} Mailbox information object
 */
function parseSELECT(response) {
  if (!response || !response.payload) {
    return;
  }

  let mailbox = {
    readOnly: response.code === 'READ-ONLY'
  };
  let existsResponse = response.payload.EXISTS && response.payload.EXISTS.pop();
  let flagsResponse = response.payload.FLAGS && response.payload.FLAGS.pop();
  let okResponse = response.payload.OK;

  if (existsResponse) {
    mailbox.exists = existsResponse.nr || 0;
  }

  if (flagsResponse && flagsResponse.attributes && flagsResponse.attributes.length) {
    mailbox.flags = flagsResponse.attributes[0].map(flag => (flag.value || '').toString().trim());
  }

  [].concat(okResponse || []).forEach(ok => {
    switch (ok && ok.code) {
      case 'PERMANENTFLAGS':
        mailbox.permanentFlags = [].concat(ok.permanentflags || []);
        break;
      case 'UIDVALIDITY':
        mailbox.uidValidity = Number(ok.uidvalidity) || 0;
        break;
      case 'UIDNEXT':
        mailbox.uidNext = Number(ok.uidnext) || 0;
        break;
      case 'HIGHESTMODSEQ':
        mailbox.highestModseq = ok.highestmodseq || '0'; // keep 64bit uint as a string
        break;
      case 'NOMODSEQ':
        mailbox.noModseq = true;
        break;
    }
  });

  return mailbox;
}

/**
 * Parses message envelope from FETCH response. All keys in the resulting
 * object are lowercase. Address fields are all arrays with {name:, address:}
 * structured values. Unicode strings are automatically decoded.
 *
 * @param {Array} value Envelope array
 * @param {Object} Envelope object
 */
function parseENVELOPE(value) {
  let envelope = {};

  if (value[0] && value[0].value) {
    envelope.date = value[0].value;
  }

  if (value[1] && value[1].value) {
    envelope.subject = (0, _emailjsMimeCodec.mimeWordsDecode)(value[1] && value[1].value);
  }

  if (value[2] && value[2].length) {
    envelope.from = processAddresses(value[2]);
  }

  if (value[3] && value[3].length) {
    envelope.sender = processAddresses(value[3]);
  }

  if (value[4] && value[4].length) {
    envelope['reply-to'] = processAddresses(value[4]);
  }

  if (value[5] && value[5].length) {
    envelope.to = processAddresses(value[5]);
  }

  if (value[6] && value[6].length) {
    envelope.cc = processAddresses(value[6]);
  }

  if (value[7] && value[7].length) {
    envelope.bcc = processAddresses(value[7]);
  }

  if (value[8] && value[8].value) {
    envelope['in-reply-to'] = value[8].value;
  }

  if (value[9] && value[9].value) {
    envelope['message-id'] = value[9].value;
  }

  return envelope;
}

/*
 * ENVELOPE lists addresses as [name-part, source-route, username, hostname]
 * where source-route is not used anymore and can be ignored.
 * To get comparable results with other parts of the email.js stack
 * browserbox feeds the parsed address values from ENVELOPE
 * to addressparser and uses resulting values instead of the
 * pre-parsed addresses
 */
function processAddresses(list = []) {
  return list.map(addr => {
    const name = (0, _ramda.pathOr)('', ['0', 'value'], addr).trim();
    const address = (0, _ramda.pathOr)('', ['2', 'value'], addr) + '@' + (0, _ramda.pathOr)('', ['3', 'value'], addr);
    const formatted = name ? encodeAddressName(name) + ' <' + address + '>' : address;
    let parsed = (0, _emailjsAddressparser2.default)(formatted).shift(); // there should be just a single address
    parsed.name = (0, _emailjsMimeCodec.mimeWordsDecode)(parsed.name);
    return parsed;
  });
}

/**
 * If needed, encloses with quotes or mime encodes the name part of an e-mail address
 *
 * @param {String} name Name part of an address
 * @returns {String} Mime word encoded or quoted string
 */
function encodeAddressName(name) {
  if (!/^[\w ']*$/.test(name)) {
    if (/^[\x20-\x7e]*$/.test(name)) {
      return JSON.stringify(name);
    } else {
      return (0, _emailjsMimeCodec.mimeWordEncode)(name, 'Q', 52);
    }
  }
  return name;
}

/**
 * Parses message body structure from FETCH response.
 *
 * @param {Array} value BODYSTRUCTURE array
 * @param {Object} Envelope object
 */
function parseBODYSTRUCTURE(node, path = []) {
  let curNode = {};
  let i = 0;
  let part = 0;

  if (path.length) {
    curNode.part = path.join('.');
  }

  // multipart
  if (Array.isArray(node[0])) {
    curNode.childNodes = [];
    while (Array.isArray(node[i])) {
      curNode.childNodes.push(parseBODYSTRUCTURE(node[i], path.concat(++part)));
      i++;
    }

    // multipart type
    curNode.type = 'multipart/' + ((node[i++] || {}).value || '').toString().toLowerCase();

    // extension data (not available for BODY requests)

    // body parameter parenthesized list
    if (i < node.length - 1) {
      if (node[i]) {
        curNode.parameters = attributesToObject(node[i]);
      }
      i++;
    }
  } else {
    // content type
    curNode.type = [((node[i++] || {}).value || '').toString().toLowerCase(), ((node[i++] || {}).value || '').toString().toLowerCase()].join('/');

    // body parameter parenthesized list
    if (node[i]) {
      curNode.parameters = attributesToObject(node[i]);
    }
    i++;

    // id
    if (node[i]) {
      curNode.id = ((node[i] || {}).value || '').toString();
    }
    i++;

    // description
    if (node[i]) {
      curNode.description = ((node[i] || {}).value || '').toString();
    }
    i++;

    // encoding
    if (node[i]) {
      curNode.encoding = ((node[i] || {}).value || '').toString().toLowerCase();
    }
    i++;

    // size
    if (node[i]) {
      curNode.size = Number((node[i] || {}).value || 0) || 0;
    }
    i++;

    if (curNode.type === 'message/rfc822') {
      // message/rfc adds additional envelope, bodystructure and line count values

      // envelope
      if (node[i]) {
        curNode.envelope = parseENVELOPE([].concat(node[i] || []));
      }
      i++;

      if (node[i]) {
        curNode.childNodes = [
        // rfc822 bodyparts share the same path, difference is between MIME and HEADER
        // path.MIME returns message/rfc822 header
        // path.HEADER returns inlined message header
        parseBODYSTRUCTURE(node[i], path)];
      }
      i++;

      // line count
      if (node[i]) {
        curNode.lineCount = Number((node[i] || {}).value || 0) || 0;
      }
      i++;
    } else if (/^text\//.test(curNode.type)) {
      // text/* adds additional line count values

      // line count
      if (node[i]) {
        curNode.lineCount = Number((node[i] || {}).value || 0) || 0;
      }
      i++;
    }

    // extension data (not available for BODY requests)

    // md5
    if (i < node.length - 1) {
      if (node[i]) {
        curNode.md5 = ((node[i] || {}).value || '').toString().toLowerCase();
      }
      i++;
    }
  }

  // the following are shared extension values (for both multipart and non-multipart parts)
  // not available for BODY requests

  // body disposition
  if (i < node.length - 1) {
    if (Array.isArray(node[i]) && node[i].length) {
      curNode.disposition = ((node[i][0] || {}).value || '').toString().toLowerCase();
      if (Array.isArray(node[i][1])) {
        curNode.dispositionParameters = attributesToObject(node[i][1]);
      }
    }
    i++;
  }

  // body language
  if (i < node.length - 1) {
    if (node[i]) {
      curNode.language = [].concat(node[i]).map(val => (0, _ramda.propOr)('', 'value', val).toLowerCase());
    }
    i++;
  }

  // body location
  // NB! defined as a "string list" in RFC3501 but replaced in errata document with "string"
  // Errata: http://www.rfc-editor.org/errata_search.php?rfc=3501
  if (i < node.length - 1) {
    if (node[i]) {
      curNode.location = ((node[i] || {}).value || '').toString();
    }
    i++;
  }

  return curNode;
}

function attributesToObject(attrs = [], keyTransform = _ramda.toLower, valueTransform = _emailjsMimeCodec.mimeWordsDecode) {
  const vals = attrs.map((0, _ramda.prop)('value'));
  const keys = vals.filter((_, i) => i % 2 === 0).map(keyTransform);
  const values = vals.filter((_, i) => i % 2 === 1).map(valueTransform);
  return (0, _ramda.fromPairs)((0, _ramda.zip)(keys, values));
}

/**
 * Parses FETCH response
 *
 * @param {Object} response
 * @return {Object} Message object
 */
function parseFETCH(response) {
  if (!response || !response.payload || !response.payload.FETCH || !response.payload.FETCH.length) {
    return [];
  }

  let list = [];
  let messages = {};

  response.payload.FETCH.forEach(item => {
    let params = [].concat([].concat(item.attributes || [])[0] || []); // ensure the first value is an array
    let message;
    let i, len, key;

    if (messages[item.nr]) {
      // same sequence number is already used, so merge values instead of creating a new message object
      message = messages[item.nr];
    } else {
      messages[item.nr] = message = {
        '#': item.nr
      };
      list.push(message);
    }

    for (i = 0, len = params.length; i < len; i++) {
      if (i % 2 === 0) {
        key = (0, _emailjsImapHandler.compiler)({
          attributes: [params[i]]
        }).toLowerCase().replace(/<\d+>$/, '');
        continue;
      }
      message[key] = parseFetchValue(key, params[i]);
    }
  });

  return list;
}

/**
 * Parses a single value from the FETCH response object
 *
 * @param {String} key Key name (uppercase)
 * @param {Mized} value Value for the key
 * @return {Mixed} Processed value
 */
function parseFetchValue(key, value) {
  if (!value) {
    return null;
  }

  if (!Array.isArray(value)) {
    switch (key) {
      case 'uid':
      case 'rfc822.size':
        return Number(value.value) || 0;
      case 'modseq':
        // do not cast 64 bit uint to a number
        return value.value || '0';
    }
    return value.value;
  }

  switch (key) {
    case 'flags':
    case 'x-gm-labels':
      value = [].concat(value).map(flag => flag.value || '');
      break;
    case 'envelope':
      value = parseENVELOPE([].concat(value || []));
      break;
    case 'bodystructure':
      value = parseBODYSTRUCTURE([].concat(value || []));
      break;
    case 'modseq':
      value = (value.shift() || {}).value || '0';
      break;
  }

  return value;
}

/**
 * Parses SEARCH response. Gathers all untagged SEARCH responses, fetched seq./uid numbers
 * and compiles these into a sorted array.
 *
 * @param {Object} response
 * @return {Object} Message object
 * @param {Array} Sorted Seq./UID number list
 */
function parseSEARCH(response) {
  return (0, _ramda.pipe)((0, _ramda.pathOr)([], ['payload', 'SEARCH']), (0, _ramda.map)(x => x.attributes || []), _ramda.flatten, (0, _ramda.map)(nr => Number((0, _ramda.propOr)(nr || 0, 'value', nr)) || 0), (0, _ramda.sort)((a, b) => a > b))(response);
}

function parseSORT(response) {
  return (0, _ramda.pipe)((0, _ramda.pathOr)([], ['payload', 'SORT']), (0, _ramda.map)(x => x.attributes || []), _ramda.flatten, (0, _ramda.map)(nr => Number((0, _ramda.propOr)(nr || 0, 'value', nr)) || 0), (0, _ramda.sort)((a, b) => a > b))(response);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21tYW5kLXBhcnNlci5qcyJdLCJuYW1lcyI6WyJwYXJzZU5BTUVTUEFDRSIsInBhcnNlTkFNRVNQQUNFRWxlbWVudCIsInBhcnNlU0VMRUNUIiwicGFyc2VFTlZFTE9QRSIsInBhcnNlQk9EWVNUUlVDVFVSRSIsInBhcnNlRkVUQ0giLCJwYXJzZVNFQVJDSCIsInBhcnNlU09SVCIsInJlc3BvbnNlIiwicGF5bG9hZCIsIk5BTUVTUEFDRSIsImxlbmd0aCIsImF0dHJpYnV0ZXMiLCJjb25jYXQiLCJwb3AiLCJwZXJzb25hbCIsInVzZXJzIiwic2hhcmVkIiwiZWxlbWVudCIsIm1hcCIsIm5zIiwicHJlZml4IiwidmFsdWUiLCJkZWxpbWl0ZXIiLCJtYWlsYm94IiwicmVhZE9ubHkiLCJjb2RlIiwiZXhpc3RzUmVzcG9uc2UiLCJFWElTVFMiLCJmbGFnc1Jlc3BvbnNlIiwiRkxBR1MiLCJva1Jlc3BvbnNlIiwiT0siLCJleGlzdHMiLCJuciIsImZsYWdzIiwiZmxhZyIsInRvU3RyaW5nIiwidHJpbSIsImZvckVhY2giLCJvayIsInBlcm1hbmVudEZsYWdzIiwicGVybWFuZW50ZmxhZ3MiLCJ1aWRWYWxpZGl0eSIsIk51bWJlciIsInVpZHZhbGlkaXR5IiwidWlkTmV4dCIsInVpZG5leHQiLCJoaWdoZXN0TW9kc2VxIiwiaGlnaGVzdG1vZHNlcSIsIm5vTW9kc2VxIiwiZW52ZWxvcGUiLCJkYXRlIiwic3ViamVjdCIsImZyb20iLCJwcm9jZXNzQWRkcmVzc2VzIiwic2VuZGVyIiwidG8iLCJjYyIsImJjYyIsImxpc3QiLCJhZGRyIiwibmFtZSIsImFkZHJlc3MiLCJmb3JtYXR0ZWQiLCJlbmNvZGVBZGRyZXNzTmFtZSIsInBhcnNlZCIsInNoaWZ0IiwidGVzdCIsIkpTT04iLCJzdHJpbmdpZnkiLCJub2RlIiwicGF0aCIsImN1ck5vZGUiLCJpIiwicGFydCIsImpvaW4iLCJBcnJheSIsImlzQXJyYXkiLCJjaGlsZE5vZGVzIiwicHVzaCIsInR5cGUiLCJ0b0xvd2VyQ2FzZSIsInBhcmFtZXRlcnMiLCJhdHRyaWJ1dGVzVG9PYmplY3QiLCJpZCIsImRlc2NyaXB0aW9uIiwiZW5jb2RpbmciLCJzaXplIiwibGluZUNvdW50IiwibWQ1IiwiZGlzcG9zaXRpb24iLCJkaXNwb3NpdGlvblBhcmFtZXRlcnMiLCJsYW5ndWFnZSIsInZhbCIsImxvY2F0aW9uIiwiYXR0cnMiLCJrZXlUcmFuc2Zvcm0iLCJ0b0xvd2VyIiwidmFsdWVUcmFuc2Zvcm0iLCJtaW1lV29yZHNEZWNvZGUiLCJ2YWxzIiwia2V5cyIsImZpbHRlciIsIl8iLCJ2YWx1ZXMiLCJGRVRDSCIsIm1lc3NhZ2VzIiwiaXRlbSIsInBhcmFtcyIsIm1lc3NhZ2UiLCJsZW4iLCJrZXkiLCJyZXBsYWNlIiwicGFyc2VGZXRjaFZhbHVlIiwieCIsImZsYXR0ZW4iLCJhIiwiYiJdLCJtYXBwaW5ncyI6Ijs7Ozs7UUFXZ0JBLGMsR0FBQUEsYztRQXVCQUMscUIsR0FBQUEscUI7UUF3QkFDLFcsR0FBQUEsVztRQW1EQUMsYSxHQUFBQSxhO1FBd0ZBQyxrQixHQUFBQSxrQjtRQThKQUMsVSxHQUFBQSxVO1FBdUZBQyxXLEdBQUFBLFc7UUFXQUMsUyxHQUFBQSxTOztBQXJjaEI7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBOzs7Ozs7QUFNTyxTQUFTUCxjQUFULENBQXdCUSxRQUF4QixFQUFrQztBQUN2QyxNQUFJLENBQUNBLFNBQVNDLE9BQVYsSUFBcUIsQ0FBQ0QsU0FBU0MsT0FBVCxDQUFpQkMsU0FBdkMsSUFBb0QsQ0FBQ0YsU0FBU0MsT0FBVCxDQUFpQkMsU0FBakIsQ0FBMkJDLE1BQXBGLEVBQTRGO0FBQzFGLFdBQU8sS0FBUDtBQUNEOztBQUVELE1BQUlDLGFBQWEsR0FBR0MsTUFBSCxDQUFVTCxTQUFTQyxPQUFULENBQWlCQyxTQUFqQixDQUEyQkksR0FBM0IsR0FBaUNGLFVBQWpDLElBQStDLEVBQXpELENBQWpCO0FBQ0EsTUFBSSxDQUFDQSxXQUFXRCxNQUFoQixFQUF3QjtBQUN0QixX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QUFPVixNQUFNLENBQWIsRUFBZ0IsT0FBaEIsRUFBeUJBLEVBQXpCLENBQVAsS0FBd0MsQ0FBbEQsQ0FKSyxFQUtMLGlCQUFLLENBQUNtRixDQUFELEVBQUlDLENBQUosS0FBVUQsSUFBSUMsQ0FBbkIsQ0FMSyxFQU1MOUcsUUFOSyxDQUFQO0FBT0Q7O0FBR00sU0FBU0QsU0FBVCxDQUFtQkMsUUFBbkIsRUFBNkI7QUFDbEMsU0FBTyxpQkFDTCxtQkFBTyxFQUFQLEVBQVcsQ0FBQyxTQUFELEVBQVksTUFBWixDQUFYLENBREssRUFFTCxnQkFBSTJHLEtBQUtBLEVBQUV2RyxVQUFGLElBQWdCLEVBQXpCLENBRkssRUFHTHdHLGNBSEssRUFJTCxnQkFBSWxGLE1BQU1VLE9BQU8sbUJBQU9WLE1BQU0sQ0FBYixFQUFnQixPQUFoQixFQUF5QkEsRUFBekIsQ0FBUCxLQUF3QyxDQUFsRCxDQUpLLEVBS0wsaUJBQUssQ0FBQ21GLENBQUQsRUFBSUMsQ0FBSixLQUFVRCxJQUFJQyxDQUFuQixDQUxLLEVBTUw5RyxRQU5LLENBQVA7QUFPRCIsImZpbGUiOiJjb21tYW5kLXBhcnNlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXJzZUFkZHJlc3MgZnJvbSAnZW1haWxqcy1hZGRyZXNzcGFyc2VyJ1xuaW1wb3J0IHsgY29tcGlsZXIgfSBmcm9tICdlbWFpbGpzLWltYXAtaGFuZGxlcidcbmltcG9ydCB7IHNvcnQsIG1hcCwgcGlwZSwgemlwLCBmcm9tUGFpcnMsIHByb3AsIHBhdGhPciwgcHJvcE9yLCBmbGF0dGVuLCB0b0xvd2VyIH0gZnJvbSAncmFtZGEnXG5pbXBvcnQgeyBtaW1lV29yZEVuY29kZSwgbWltZVdvcmRzRGVjb2RlIH0gZnJvbSAnZW1haWxqcy1taW1lLWNvZGVjJ1xuXG4vKipcbiAqIFBhcnNlcyBOQU1FU1BBQ0UgcmVzcG9uc2VcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gcmVzcG9uc2VcbiAqIEByZXR1cm4ge09iamVjdH0gTmFtZXNwYWNlcyBvYmplY3RcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlTkFNRVNQQUNFKHJlc3BvbnNlKSB7XG4gIGlmICghcmVzcG9uc2UucGF5bG9hZCB8fCAhcmVzcG9uc2UucGF5bG9hZC5OQU1FU1BBQ0UgfHwgIXJlc3BvbnNlLnBheWxvYWQuTkFNRVNQQUNFLmxlbmd0aCkge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgbGV0IGF0dHJpYnV0ZXMgPSBbXS5jb25jYXQocmVzcG9uc2UucGF5bG9hZC5OQU1FU1BBQ0UucG9wKCkuYXR0cmlidXRlcyB8fCBbXSlcbiAgaWYgKCFhdHRyaWJ1dGVzLmxlbmd0aCkge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBwZXJzb25hbDogcGFyc2VOQU1FU1BBQ0VFbGVtZW50KGF0dHJpYnV0ZXNbMF0pLFxuICAgIHVzZXJzOiBwYXJzZU5BTUVTUEFDRUVsZW1lbnQoYXR0cmlidXRlc1sxXSksXG4gICAgc2hhcmVkOiBwYXJzZU5BTUVTUEFDRUVsZW1lbnQoYXR0cmlidXRlc1syXSlcbiAgfVxufVxuXG4vKipcbiAqIFBhcnNlcyBhIE5BTUVTUEFDRSBlbGVtZW50XG4gKlxuICogQHBhcmFtIHtPYmplY3R9IGVsZW1lbnRcbiAqIEByZXR1cm4ge09iamVjdH0gTmFtZXNwYWNlcyBlbGVtZW50IG9iamVjdFxuICovXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VOQU1FU1BBQ0VFbGVtZW50KGVsZW1lbnQpIHtcbiAgaWYgKCFlbGVtZW50KSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBlbGVtZW50ID0gW10uY29uY2F0KGVsZW1lbnQgfHwgW10pXG4gIHJldHVybiBlbGVtZW50Lm1hcCgobnMpID0+IHtcbiAgICBpZiAoIW5zIHx8ICFucy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBwcmVmaXg6IG5zWzBdLnZhbHVlLFxuICAgICAgZGVsaW1pdGVyOiBuc1sxXSAmJiBuc1sxXS52YWx1ZSAvLyBUaGUgZGVsaW1pdGVyIGNhbiBsZWdhbGx5IGJlIE5JTCB3aGljaCBtYXBzIHRvIG51bGxcbiAgICB9XG4gIH0pXG59XG5cbi8qKlxuICogUGFyc2VzIFNFTEVDVCByZXNwb25zZVxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSByZXNwb25zZVxuICogQHJldHVybiB7T2JqZWN0fSBNYWlsYm94IGluZm9ybWF0aW9uIG9iamVjdFxuICovXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VTRUxFQ1QocmVzcG9uc2UpIHtcbiAgaWYgKCFyZXNwb25zZSB8fCAhcmVzcG9uc2UucGF5bG9hZCkge1xuICAgIHJldHVyblxuICB9XG5cbiAgbGV0IG1haWxib3ggPSB7XG4gICAgcmVhZE9ubHk6IHJlc3BvbnNlLmNvZGUgPT09ICdSRUFELU9OTFknXG4gIH1cbiAgbGV0IGV4aXN0c1Jlc3BvbnNlID0gcmVzcG9uc2UucGF5bG9hZC5FWElTVFMgJiYgcmVzcG9uc2UucGF5bG9hZC5FWElTVFMucG9wKClcbiAgbGV0IGZsYWdzUmVzcG9uc2UgPSByZXNwb25zZS5wYXlsb2FkLkZMQUdTICYmIHJlc3BvbnNlLnBheWxvYWQuRkxBR1MucG9wKClcbiAgbGV0IG9rUmVzcG9uc2UgPSByZXNwb25zZS5wYXlsb2FkLk9LXG5cbiAgaWYgKGV4aXN0c1Jlc3BvbnNlKSB7XG4gICAgbWFpbGJveC5leGlzdHMgPSBleGlzdHNSZXNwb25zZS5uciB8fCAwXG4gIH1cblxuICBpZiAoZmxhZ3NSZXNwb25zZSAmJiBmbGFnc1Jlc3BvbnNlLmF0dHJpYnV0ZXMgJiYgZmxhZ3NSZXNwb25zZS5hdHRyaWJ1dGVzLmxlbmd0aCkge1xuICAgIG1haWxib3guZmxhZ3MgPSBmbGFnc1Jlc3BvbnNlLmF0dHJpYnV0ZXNbMF0ubWFwKChmbGFnKSA9PiAoZmxhZy52YWx1ZSB8fCAnJykudG9TdHJpbmcoKS50cmltKCkpXG4gIH1cblxuICBbXS5jb25jYXQob2tSZXNwb25zZSB8fCBbXSkuZm9yRWFjaCgob2spID0+IHtcbiAgICBzd2l0Y2ggKG9rICYmIG9rLmNvZGUpIHtcbiAgICAgIGNhc2UgJ1BFUk1BTkVOVEZMQUdTJzpcbiAgICAgICAgbWFpbGJveC5wZXJtYW5lbnRGbGFncyA9IFtdLmNvbmNhdChvay5wZXJtYW5lbnRmbGFncyB8fCBbXSlcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgJ1VJRFZBTElESVRZJzpcbiAgICAgICAgbWFpbGJveC51aWRWYWxpZGl0eSA9IE51bWJlcihvay51aWR2YWxpZGl0eSkgfHwgMFxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAnVUlETkVYVCc6XG4gICAgICAgIG1haWxib3gudWlkTmV4dCA9IE51bWJlcihvay51aWRuZXh0KSB8fCAwXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlICdISUdIRVNUTU9EU0VRJzpcbiAgICAgICAgbWFpbGJveC5oaWdoZXN0TW9kc2VxID0gb2suaGlnaGVzdG1vZHNlcSB8fCAnMCcgLy8ga2VlcCA2NGJpdCB1aW50IGFzIGEgc3RyaW5nXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlICdOT01PRFNFUSc6XG4gICAgICAgIG1haWxib3gubm9Nb2RzZXEgPSB0cnVlXG4gICAgICAgIGJyZWFrXG4gICAgfVxuICB9KVxuXG4gIHJldHVybiBtYWlsYm94XG59XG5cbi8qKlxuICogUGFyc2VzIG1lc3NhZ2UgZW52ZWxvcGUgZnJvbSBGRVRDSCByZXNwb25zZS4gQWxsIGtleXMgaW4gdGhlIHJlc3VsdGluZ1xuICogb2JqZWN0IGFyZSBsb3dlcmNhc2UuIEFkZHJlc3MgZmllbGRzIGFyZSBhbGwgYXJyYXlzIHdpdGgge25hbWU6LCBhZGRyZXNzOn1cbiAqIHN0cnVjdHVyZWQgdmFsdWVzLiBVbmljb2RlIHN0cmluZ3MgYXJlIGF1dG9tYXRpY2FsbHkgZGVjb2RlZC5cbiAqXG4gKiBAcGFyYW0ge0FycmF5fSB2YWx1ZSBFbnZlbG9wZSBhcnJheVxuICogQHBhcmFtIHtPYmplY3R9IEVudmVsb3BlIG9iamVjdFxuICovXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VFTlZFTE9QRSh2YWx1ZSkge1xuICBsZXQgZW52ZWxvcGUgPSB7fVxuXG4gIGlmICh2YWx1ZVswXSAmJiB2YWx1ZVswXS52YWx1ZSkge1xuICAgIGVudmVsb3BlLmRhdGUgPSB2YWx1ZVswXS52YWx1ZVxuICB9XG5cbiAgaWYgKHZhbHVlWzFdICYmIHZhbHVlWzFdLnZhbHVlKSB7XG4gICAgZW52ZWxvcGUuc3ViamVjdCA9IG1pbWVXb3Jkc0RlY29kZSh2YWx1ZVsxXSAmJiB2YWx1ZVsxXS52YWx1ZSlcbiAgfVxuXG4gIGlmICh2YWx1ZVsyXSAmJiB2YWx1ZVsyXS5sZW5ndGgpIHtcbiAgICBlbnZlbG9wZS5mcm9tID0gcHJvY2Vzc0FkZHJlc3Nlcyh2YWx1ZVsyXSlcbiAgfVxuXG4gIGlmICh2YWx1ZVszXSAmJiB2YWx1ZVszXS5sZW5ndGgpIHtcbiAgICBlbnZlbG9wZS5zZW5kZXIgPSBwcm9jZXNzQWRkcmVzc2VzKHZhbHVlWzNdKVxuICB9XG5cbiAgaWYgKHZhbHVlWzRdICYmIHZhbHVlWzRdLmxlbmd0aCkge1xuICAgIGVudmVsb3BlWydyZXBseS10byddID0gcHJvY2Vzc0FkZHJlc3Nlcyh2YWx1ZVs0XSlcbiAgfVxuXG4gIGlmICh2YWx1ZVs1XSAmJiB2YWx1ZVs1XS5sZW5ndGgpIHtcbiAgICBlbnZlbG9wZS50byA9IHByb2Nlc3NBZGRyZXNzZXModmFsdWVbNV0pXG4gIH1cblxuICBpZiAodmFsdWVbNl0gJiYgdmFsdWVbNl0ubGVuZ3RoKSB7XG4gICAgZW52ZWxvcGUuY2MgPSBwcm9jZXNzQWRkcmVzc2VzKHZhbHVlWzZdKVxuICB9XG5cbiAgaWYgKHZhbHVlWzddICYmIHZhbHVlWzddLmxlbmd0aCkge1xuICAgIGVudmVsb3BlLmJjYyA9IHByb2Nlc3NBZGRyZXNzZXModmFsdWVbN10pXG4gIH1cblxuICBpZiAodmFsdWVbOF0gJiYgdmFsdWVbOF0udmFsdWUpIHtcbiAgICBlbnZlbG9wZVsnaW4tcmVwbHktdG8nXSA9IHZhbHVlWzhdLnZhbHVlXG4gIH1cblxuICBpZiAodmFsdWVbOV0gJiYgdmFsdWVbOV0udmFsdWUpIHtcbiAgICBlbnZlbG9wZVsnbWVzc2FnZS1pZCddID0gdmFsdWVbOV0udmFsdWVcbiAgfVxuXG4gIHJldHVybiBlbnZlbG9wZVxufVxuXG4vKlxuICogRU5WRUxPUEUgbGlzdHMgYWRkcmVzc2VzIGFzIFtuYW1lLXBhcnQsIHNvdXJjZS1yb3V0ZSwgdXNlcm5hbWUsIGhvc3RuYW1lXVxuICogd2hlcmUgc291cmNlLXJvdXRlIGlzIG5vdCB1c2VkIGFueW1vcmUgYW5kIGNhbiBiZSBpZ25vcmVkLlxuICogVG8gZ2V0IGNvbXBhcmFibGUgcmVzdWx0cyB3aXRoIG90aGVyIHBhcnRzIG9mIHRoZSBlbWFpbC5qcyBzdGFja1xuICogYnJvd3NlcmJveCBmZWVkcyB0aGUgcGFyc2VkIGFkZHJlc3MgdmFsdWVzIGZyb20gRU5WRUxPUEVcbiAqIHRvIGFkZHJlc3NwYXJzZXIgYW5kIHVzZXMgcmVzdWx0aW5nIHZhbHVlcyBpbnN0ZWFkIG9mIHRoZVxuICogcHJlLXBhcnNlZCBhZGRyZXNzZXNcbiAqL1xuZnVuY3Rpb24gcHJvY2Vzc0FkZHJlc3NlcyhsaXN0ID0gW10pIHtcbiAgcmV0dXJuIGxpc3QubWFwKChhZGRyKSA9PiB7XG4gICAgY29uc3QgbmFtZSA9IChwYXRoT3IoJycsIFsnMCcsICd2YWx1ZSddLCBhZGRyKSkudHJpbSgpXG4gICAgY29uc3QgYWRkcmVzcyA9IChwYXRoT3IoJycsIFsnMicsICd2YWx1ZSddLCBhZGRyKSkgKyAnQCcgKyAocGF0aE9yKCcnLCBbJzMnLCAndmFsdWUnXSwgYWRkcikpXG4gICAgY29uc3QgZm9ybWF0dGVkID0gbmFtZSA/IChlbmNvZGVBZGRyZXNzTmFtZShuYW1lKSArICcgPCcgKyBhZGRyZXNzICsgJz4nKSA6IGFkZHJlc3NcbiAgICBsZXQgcGFyc2VkID0gcGFyc2VBZGRyZXNzKGZvcm1hdHRlZCkuc2hpZnQoKSAvLyB0aGVyZSBzaG91bGQgYmUganVzdCBhIHNpbmdsZSBhZGRyZXNzXG4gICAgcGFyc2VkLm5hbWUgPSBtaW1lV29yZHNEZWNvZGUocGFyc2VkLm5hbWUpXG4gICAgcmV0dXJuIHBhcnNlZFxuICB9KVxufVxuXG4vKipcbiAqIElmIG5lZWRlZCwgZW5jbG9zZXMgd2l0aCBxdW90ZXMgb3IgbWltZSBlbmNvZGVzIHRoZSBuYW1lIHBhcnQgb2YgYW4gZS1tYWlsIGFkZHJlc3NcbiAqXG4gKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBOYW1lIHBhcnQgb2YgYW4gYWRkcmVzc1xuICogQHJldHVybnMge1N0cmluZ30gTWltZSB3b3JkIGVuY29kZWQgb3IgcXVvdGVkIHN0cmluZ1xuICovXG5mdW5jdGlvbiBlbmNvZGVBZGRyZXNzTmFtZShuYW1lKSB7XG4gIGlmICghL15bXFx3ICddKiQvLnRlc3QobmFtZSkpIHtcbiAgICBpZiAoL15bXFx4MjAtXFx4N2VdKiQvLnRlc3QobmFtZSkpIHtcbiAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShuYW1lKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbWltZVdvcmRFbmNvZGUobmFtZSwgJ1EnLCA1MilcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG5hbWVcbn1cblxuLyoqXG4gKiBQYXJzZXMgbWVzc2FnZSBib2R5IHN0cnVjdHVyZSBmcm9tIEZFVENIIHJlc3BvbnNlLlxuICpcbiAqIEBwYXJhbSB7QXJyYXl9IHZhbHVlIEJPRFlTVFJVQ1RVUkUgYXJyYXlcbiAqIEBwYXJhbSB7T2JqZWN0fSBFbnZlbG9wZSBvYmplY3RcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlQk9EWVNUUlVDVFVSRShub2RlLCBwYXRoID0gW10pIHtcbiAgbGV0IGN1ck5vZGUgPSB7fVxuICBsZXQgaSA9IDBcbiAgbGV0IHBhcnQgPSAwXG5cbiAgaWYgKHBhdGgubGVuZ3RoKSB7XG4gICAgY3VyTm9kZS5wYXJ0ID0gcGF0aC5qb2luKCcuJylcbiAgfVxuXG4gIC8vIG11bHRpcGFydFxuICBpZiAoQXJyYXkuaXNBcnJheShub2RlWzBdKSkge1xuICAgIGN1ck5vZGUuY2hpbGROb2RlcyA9IFtdXG4gICAgd2hpbGUgKEFycmF5LmlzQXJyYXkobm9kZVtpXSkpIHtcbiAgICAgIGN1ck5vZGUuY2hpbGROb2Rlcy5wdXNoKHBhcnNlQk9EWVNUUlVDVFVSRShub2RlW2ldLCBwYXRoLmNvbmNhdCgrK3BhcnQpKSlcbiAgICAgIGkrK1xuICAgIH1cblxuICAgIC8vIG11bHRpcGFydCB0eXBlXG4gICAgY3VyTm9kZS50eXBlID0gJ211bHRpcGFydC8nICsgKChub2RlW2krK10gfHwge30pLnZhbHVlIHx8ICcnKS50b1N0cmluZygpLnRvTG93ZXJDYXNlKClcblxuICAgIC8vIGV4dGVuc2lvbiBkYXRhIChub3QgYXZhaWxhYmxlIGZvciBCT0RZIHJlcXVlc3RzKVxuXG4gICAgLy8gYm9keSBwYXJhbWV0ZXIgcGFyZW50aGVzaXplZCBsaXN0XG4gICAgaWYgKGkgPCBub2RlLmxlbmd0aCAtIDEpIHtcbiAgICAgIGlmIChub2RlW2ldKSB7XG4gICAgICAgIGN1ck5vZGUucGFyYW1ldGVycyA9IGF0dHJpYnV0ZXNUb09iamVjdChub2RlW2ldKVxuICAgICAgfVxuICAgICAgaSsrXG4gICAgfVxuICB9IGVsc2Uge1xuICAgIC8vIGNvbnRlbnQgdHlwZVxuICAgIGN1ck5vZGUudHlwZSA9IFtcbiAgICAgICgobm9kZVtpKytdIHx8IHt9KS52YWx1ZSB8fCAnJykudG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpLCAoKG5vZGVbaSsrXSB8fCB7fSkudmFsdWUgfHwgJycpLnRvU3RyaW5nKCkudG9Mb3dlckNhc2UoKVxuICAgIF0uam9pbignLycpXG5cbiAgICAvLyBib2R5IHBhcmFtZXRlciBwYXJlbnRoZXNpemVkIGxpc3RcbiAgICBpZiAobm9kZVtpXSkge1xuICAgICAgY3VyTm9kZS5wYXJhbWV0ZXJzID0gYXR0cmlidXRlc1RvT2JqZWN0KG5vZGVbaV0pXG4gICAgfVxuICAgIGkrK1xuXG4gICAgLy8gaWRcbiAgICBpZiAobm9kZVtpXSkge1xuICAgICAgY3VyTm9kZS5pZCA9ICgobm9kZVtpXSB8fCB7fSkudmFsdWUgfHwgJycpLnRvU3RyaW5nKClcbiAgICB9XG4gICAgaSsrXG5cbiAgICAvLyBkZXNjcmlwdGlvblxuICAgIGlmIChub2RlW2ldKSB7XG4gICAgICBjdXJOb2RlLmRlc2NyaXB0aW9uID0gKChub2RlW2ldIHx8IHt9KS52YWx1ZSB8fCAnJykudG9TdHJpbmcoKVxuICAgIH1cbiAgICBpKytcblxuICAgIC8vIGVuY29kaW5nXG4gICAgaWYgKG5vZGVbaV0pIHtcbiAgICAgIGN1ck5vZGUuZW5jb2RpbmcgPSAoKG5vZGVbaV0gfHwge30pLnZhbHVlIHx8ICcnKS50b1N0cmluZygpLnRvTG93ZXJDYXNlKClcbiAgICB9XG4gICAgaSsrXG5cbiAgICAvLyBzaXplXG4gICAgaWYgKG5vZGVbaV0pIHtcbiAgICAgIGN1ck5vZGUuc2l6ZSA9IE51bWJlcigobm9kZVtpXSB8fCB7fSkudmFsdWUgfHwgMCkgfHwgMFxuICAgIH1cbiAgICBpKytcblxuICAgIGlmIChjdXJOb2RlLnR5cGUgPT09ICdtZXNzYWdlL3JmYzgyMicpIHtcbiAgICAgIC8vIG1lc3NhZ2UvcmZjIGFkZHMgYWRkaXRpb25hbCBlbnZlbG9wZSwgYm9keXN0cnVjdHVyZSBhbmQgbGluZSBjb3VudCB2YWx1ZXNcblxuICAgICAgLy8gZW52ZWxvcGVcbiAgICAgIGlmIChub2RlW2ldKSB7XG4gICAgICAgIGN1ck5vZGUuZW52ZWxvcGUgPSBwYXJzZUVOVkVMT1BFKFtdLmNvbmNhdChub2RlW2ldIHx8IFtdKSlcbiAgICAgIH1cbiAgICAgIGkrK1xuXG4gICAgICBpZiAobm9kZVtpXSkge1xuICAgICAgICBjdXJOb2RlLmNoaWxkTm9kZXMgPSBbXG4gICAgICAgICAgLy8gcmZjODIyIGJvZHlwYXJ0cyBzaGFyZSB0aGUgc2FtZSBwYXRoLCBkaWZmZXJlbmNlIGlzIGJldHdlZW4gTUlNRSBhbmQgSEVBREVSXG4gICAgICAgICAgLy8gcGF0aC5NSU1FIHJldHVybnMgbWVzc2FnZS9yZmM4MjIgaGVhZGVyXG4gICAgICAgICAgLy8gcGF0aC5IRUFERVIgcmV0dXJucyBpbmxpbmVkIG1lc3NhZ2UgaGVhZGVyXG4gICAgICAgICAgcGFyc2VCT0RZU1RSVUNUVVJFKG5vZGVbaV0sIHBhdGgpXG4gICAgICAgIF1cbiAgICAgIH1cbiAgICAgIGkrK1xuXG4gICAgICAvLyBsaW5lIGNvdW50XG4gICAgICBpZiAobm9kZVtpXSkge1xuICAgICAgICBjdXJOb2RlLmxpbmVDb3VudCA9IE51bWJlcigobm9kZVtpXSB8fCB7fSkudmFsdWUgfHwgMCkgfHwgMFxuICAgICAgfVxuICAgICAgaSsrXG4gICAgfSBlbHNlIGlmICgvXnRleHRcXC8vLnRlc3QoY3VyTm9kZS50eXBlKSkge1xuICAgICAgLy8gdGV4dC8qIGFkZHMgYWRkaXRpb25hbCBsaW5lIGNvdW50IHZhbHVlc1xuXG4gICAgICAvLyBsaW5lIGNvdW50XG4gICAgICBpZiAobm9kZVtpXSkge1xuICAgICAgICBjdXJOb2RlLmxpbmVDb3VudCA9IE51bWJlcigobm9kZVtpXSB8fCB7fSkudmFsdWUgfHwgMCkgfHwgMFxuICAgICAgfVxuICAgICAgaSsrXG4gICAgfVxuXG4gICAgLy8gZXh0ZW5zaW9uIGRhdGEgKG5vdCBhdmFpbGFibGUgZm9yIEJPRFkgcmVxdWVzdHMpXG5cbiAgICAvLyBtZDVcbiAgICBpZiAoaSA8IG5vZGUubGVuZ3RoIC0gMSkge1xuICAgICAgaWYgKG5vZGVbaV0pIHtcbiAgICAgICAgY3VyTm9kZS5tZDUgPSAoKG5vZGVbaV0gfHwge30pLnZhbHVlIHx8ICcnKS50b1N0cmluZygpLnRvTG93ZXJDYXNlKClcbiAgICAgIH1cbiAgICAgIGkrK1xuICAgIH1cbiAgfVxuXG4gIC8vIHRoZSBmb2xsb3dpbmcgYXJlIHNoYXJlZCBleHRlbnNpb24gdmFsdWVzIChmb3IgYm90aCBtdWx0aXBhcnQgYW5kIG5vbi1tdWx0aXBhcnQgcGFydHMpXG4gIC8vIG5vdCBhdmFpbGFibGUgZm9yIEJPRFkgcmVxdWVzdHNcblxuICAvLyBib2R5IGRpc3Bvc2l0aW9uXG4gIGlmIChpIDwgbm9kZS5sZW5ndGggLSAxKSB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZVtpXSkgJiYgbm9kZVtpXS5sZW5ndGgpIHtcbiAgICAgIGN1ck5vZGUuZGlzcG9zaXRpb24gPSAoKG5vZGVbaV1bMF0gfHwge30pLnZhbHVlIHx8ICcnKS50b1N0cmluZygpLnRvTG93ZXJDYXNlKClcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KG5vZGVbaV1bMV0pKSB7XG4gICAgICAgIGN1ck5vZGUuZGlzcG9zaXRpb25QYXJhbWV0ZXJzID0gYXR0cmlidXRlc1RvT2JqZWN0KG5vZGVbaV1bMV0pXG4gICAgICB9XG4gICAgfVxuICAgIGkrK1xuICB9XG5cbiAgLy8gYm9keSBsYW5ndWFnZVxuICBpZiAoaSA8IG5vZGUubGVuZ3RoIC0gMSkge1xuICAgIGlmIChub2RlW2ldKSB7XG4gICAgICBjdXJOb2RlLmxhbmd1YWdlID0gW10uY29uY2F0KG5vZGVbaV0pLm1hcCgodmFsKSA9PiBwcm9wT3IoJycsICd2YWx1ZScsIHZhbCkudG9Mb3dlckNhc2UoKSlcbiAgICB9XG4gICAgaSsrXG4gIH1cblxuICAvLyBib2R5IGxvY2F0aW9uXG4gIC8vIE5CISBkZWZpbmVkIGFzIGEgXCJzdHJpbmcgbGlzdFwiIGluIFJGQzM1MDEgYnV0IHJlcGxhY2VkIGluIGVycmF0YSBkb2N1bWVudCB3aXRoIFwic3RyaW5nXCJcbiAgLy8gRXJyYXRhOiBodHRwOi8vd3d3LnJmYy1lZGl0b3Iub3JnL2VycmF0YV9zZWFyY2gucGhwP3JmYz0zNTAxXG4gIGlmIChpIDwgbm9kZS5sZW5ndGggLSAxKSB7XG4gICAgaWYgKG5vZGVbaV0pIHtcbiAgICAgIGN1ck5vZGUubG9jYXRpb24gPSAoKG5vZGVbaV0gfHwge30pLnZhbHVlIHx8ICcnKS50b1N0cmluZygpXG4gICAgfVxuICAgIGkrK1xuICB9XG5cbiAgcmV0dXJuIGN1ck5vZGVcbn1cblxuZnVuY3Rpb24gYXR0cmlidXRlc1RvT2JqZWN0KGF0dHJzID0gW10sIGtleVRyYW5zZm9ybSA9IHRvTG93ZXIsIHZhbHVlVHJhbnNmb3JtID0gbWltZVdvcmRzRGVjb2RlKSB7XG4gIGNvbnN0IHZhbHMgPSBhdHRycy5tYXAocHJvcCgndmFsdWUnKSlcbiAgY29uc3Qga2V5cyA9IHZhbHMuZmlsdGVyKChfLCBpKSA9PiBpICUgMiA9PT0gMCkubWFwKGtleVRyYW5zZm9ybSlcbiAgY29uc3QgdmFsdWVzID0gdmFscy5maWx0ZXIoKF8sIGkpID0+IGkgJSAyID09PSAxKS5tYXAodmFsdWVUcmFuc2Zvcm0pXG4gIHJldHVybiBmcm9tUGFpcnMoemlwKGtleXMsIHZhbHVlcykpXG59XG5cbi8qKlxuICogUGFyc2VzIEZFVENIIHJlc3BvbnNlXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IHJlc3BvbnNlXG4gKiBAcmV0dXJuIHtPYmplY3R9IE1lc3NhZ2Ugb2JqZWN0XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZUZFVENIKHJlc3BvbnNlKSB7XG4gIGlmICghcmVzcG9uc2UgfHwgIXJlc3BvbnNlLnBheWxvYWQgfHwgIXJlc3BvbnNlLnBheWxvYWQuRkVUQ0ggfHwgIXJlc3BvbnNlLnBheWxvYWQuRkVUQ0gubGVuZ3RoKSB7XG4gICAgcmV0dXJuIFtdXG4gIH1cblxuICBsZXQgbGlzdCA9IFtdXG4gIGxldCBtZXNzYWdlcyA9IHt9XG5cbiAgcmVzcG9uc2UucGF5bG9hZC5GRVRDSC5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgbGV0IHBhcmFtcyA9IFtdLmNvbmNhdChbXS5jb25jYXQoaXRlbS5hdHRyaWJ1dGVzIHx8IFtdKVswXSB8fCBbXSkgLy8gZW5zdXJlIHRoZSBmaXJzdCB2YWx1ZSBpcyBhbiBhcnJheVxuICAgIGxldCBtZXNzYWdlXG4gICAgbGV0IGksIGxlbiwga2V5XG5cbiAgICBpZiAobWVzc2FnZXNbaXRlbS5ucl0pIHtcbiAgICAgIC8vIHNhbWUgc2VxdWVuY2UgbnVtYmVyIGlzIGFscmVhZHkgdXNlZCwgc28gbWVyZ2UgdmFsdWVzIGluc3RlYWQgb2YgY3JlYXRpbmcgYSBuZXcgbWVzc2FnZSBvYmplY3RcbiAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlc1tpdGVtLm5yXVxuICAgIH0gZWxzZSB7XG4gICAgICBtZXNzYWdlc1tpdGVtLm5yXSA9IG1lc3NhZ2UgPSB7XG4gICAgICAgICcjJzogaXRlbS5uclxuICAgICAgfVxuICAgICAgbGlzdC5wdXNoKG1lc3NhZ2UpXG4gICAgfVxuXG4gICAgZm9yIChpID0gMCwgbGVuID0gcGFyYW1zLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICBpZiAoaSAlIDIgPT09IDApIHtcbiAgICAgICAga2V5ID0gY29tcGlsZXIoe1xuICAgICAgICAgIGF0dHJpYnV0ZXM6IFtwYXJhbXNbaV1dXG4gICAgICAgIH0pLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvPFxcZCs+JC8sICcnKVxuICAgICAgICBjb250aW51ZVxuICAgICAgfVxuICAgICAgbWVzc2FnZVtrZXldID0gcGFyc2VGZXRjaFZhbHVlKGtleSwgcGFyYW1zW2ldKVxuICAgIH1cbiAgfSlcblxuICByZXR1cm4gbGlzdFxufVxuXG4vKipcbiAqIFBhcnNlcyBhIHNpbmdsZSB2YWx1ZSBmcm9tIHRoZSBGRVRDSCByZXNwb25zZSBvYmplY3RcbiAqXG4gKiBAcGFyYW0ge1N0cmluZ30ga2V5IEtleSBuYW1lICh1cHBlcmNhc2UpXG4gKiBAcGFyYW0ge01pemVkfSB2YWx1ZSBWYWx1ZSBmb3IgdGhlIGtleVxuICogQHJldHVybiB7TWl4ZWR9IFByb2Nlc3NlZCB2YWx1ZVxuICovXG5mdW5jdGlvbiBwYXJzZUZldGNoVmFsdWUoa2V5LCB2YWx1ZSkge1xuICBpZiAoIXZhbHVlKSB7XG4gICAgcmV0dXJuIG51bGxcbiAgfVxuXG4gIGlmICghQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICBzd2l0Y2ggKGtleSkge1xuICAgICAgY2FzZSAndWlkJzpcbiAgICAgIGNhc2UgJ3JmYzgyMi5zaXplJzpcbiAgICAgICAgcmV0dXJuIE51bWJlcih2YWx1ZS52YWx1ZSkgfHwgMFxuICAgICAgY2FzZSAnbW9kc2VxJzogLy8gZG8gbm90IGNhc3QgNjQgYml0IHVpbnQgdG8gYSBudW1iZXJcbiAgICAgICAgcmV0dXJuIHZhbHVlLnZhbHVlIHx8ICcwJ1xuICAgIH1cbiAgICByZXR1cm4gdmFsdWUudmFsdWVcbiAgfVxuXG4gIHN3aXRjaCAoa2V5KSB7XG4gICAgY2FzZSAnZmxhZ3MnOlxuICAgIGNhc2UgJ3gtZ20tbGFiZWxzJzpcbiAgICAgIHZhbHVlID0gW10uY29uY2F0KHZhbHVlKS5tYXAoKGZsYWcpID0+IChmbGFnLnZhbHVlIHx8ICcnKSlcbiAgICAgIGJyZWFrXG4gICAgY2FzZSAnZW52ZWxvcGUnOlxuICAgICAgdmFsdWUgPSBwYXJzZUVOVkVMT1BFKFtdLmNvbmNhdCh2YWx1ZSB8fCBbXSkpXG4gICAgICBicmVha1xuICAgIGNhc2UgJ2JvZHlzdHJ1Y3R1cmUnOlxuICAgICAgdmFsdWUgPSBwYXJzZUJPRFlTVFJVQ1RVUkUoW10uY29uY2F0KHZhbHVlIHx8IFtdKSlcbiAgICAgIGJyZWFrXG4gICAgY2FzZSAnbW9kc2VxJzpcbiAgICAgIHZhbHVlID0gKHZhbHVlLnNoaWZ0KCkgfHwge30pLnZhbHVlIHx8ICcwJ1xuICAgICAgYnJlYWtcbiAgfVxuXG4gIHJldHVybiB2YWx1ZVxufVxuXG4vKipcbiAqIFBhcnNlcyBTRUFSQ0ggcmVzcG9uc2UuIEdhdGhlcnMgYWxsIHVudGFnZ2VkIFNFQVJDSCByZXNwb25zZXMsIGZldGNoZWQgc2VxLi91aWQgbnVtYmVyc1xuICogYW5kIGNvbXBpbGVzIHRoZXNlIGludG8gYSBzb3J0ZWQgYXJyYXkuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IHJlc3BvbnNlXG4gKiBAcmV0dXJuIHtPYmplY3R9IE1lc3NhZ2Ugb2JqZWN0XG4gKiBAcGFyYW0ge0FycmF5fSBTb3J0ZWQgU2VxLi9VSUQgbnVtYmVyIGxpc3RcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlU0VBUkNIKHJlc3BvbnNlKSB7XG4gIHJldHVybiBwaXBlKFxuICAgIHBhdGhPcihbXSwgWydwYXlsb2FkJywgJ1NFQVJDSCddKSxcbiAgICBtYXAoeCA9PiB4LmF0dHJpYnV0ZXMgfHwgW10pLFxuICAgIGZsYXR0ZW4sXG4gICAgbWFwKG5yID0+IE51bWJlcihwcm9wT3IobnIgfHwgMCwgJ3ZhbHVlJywgbnIpKSB8fCAwKSxcbiAgICBzb3J0KChhLCBiKSA9PiBhID4gYilcbiAgKShyZXNwb25zZSlcbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VTT1JUKHJlc3BvbnNlKSB7XG4gIHJldHVybiBwaXBlKFxuICAgIHBhdGhPcihbXSwgWydwYXlsb2FkJywgJ1NPUlQnXSksXG4gICAgbWFwKHggPT4geC5hdHRyaWJ1dGVzIHx8IFtdKSxcbiAgICBmbGF0dGVuLFxuICAgIG1hcChuciA9PiBOdW1iZXIocHJvcE9yKG5yIHx8IDAsICd2YWx1ZScsIG5yKSkgfHwgMCksXG4gICAgc29ydCgoYSwgYikgPT4gYSA+IGIpXG4gICkocmVzcG9uc2UpXG59XG4iXX0=